id: bottleneck_pipeline
namespace: bottleneck.project

description: >
  Pipeline complet du projet P10 ‚Äì Ex√©cution des scripts 00 √† 07
  dans un environnement Docker unique, avec suivi des logs et fichiers g√©n√©r√©s.

tasks:
  - id: bloc_unique_execution_pipeline
    type: io.kestra.plugin.core.flow.WorkingDirectory

    tasks:
      # === 1. Clonage du d√©p√¥t Git contenant les scripts Python ===
      - id: clonage_du_projet
        type: io.kestra.plugin.git.Clone
        url: https://github.com/xsorouz/orchestration-bottleneck.git
        branch: main

      # === 2. Ex√©cution de tous les scripts Python dans l‚Äôordre ===
      - id: execution_pipeline_complet
        type: io.kestra.plugin.scripts.python.Commands

        # üîß Installation des biblioth√®ques n√©cessaires √† tous les scripts
        beforeCommands:
          - pip install loguru requests pandas openpyxl duckdb

        # ‚ñ∂Ô∏è Liste des scripts ex√©cut√©s dans l‚Äôordre (00 ‚ûù 07)
        commands:
          # === T√©l√©chargement + conversion ===
          - python src/00_download_and_extract.py
          - python src/01_excel_to_csv.py

          # === Nettoyage + tests associ√©s ===
          - python src/02_nettoyage.py
          - python tests/test_nettoyage.py
          - python tests/test_nulls.py
          - python tests/test_doublons.py

          # === D√©doublonnage + test ===
          - python src/03_dedoublonnage.py
          - python tests/test_dedoublonnage.py

          # === Fusion + test ===
          - python src/04_fusion.py
          - python tests/test_fusion.py

          # === Calcul CA + test ===
          - python src/05_ca.py
          - python tests/test_ca.py

          # === Z-score + test ===
          - python src/06_zscore.py
          - python tests/test_zscore.py

          # === Rapport final ===
          - python src/07_log_rapport.py

        # üì¶ Fichiers de sortie collect√©s pour audit et suivi
        outputFiles:
          - logs/download_extract.log
          - logs/conversion.log
          - logs/nettoyage.log
          - logs/dedoublonnage.log
          - logs/fusion.log
          - logs/ca.log
          - logs/zscore.log
          - logs/rapport.log
          - data/raw/erp.csv
          - data/raw/web.csv
          - data/raw/liaison.csv
          - data/outputs/fusion.csv
          - data/outputs/ca_par_produit.csv
          - data/outputs/ca_par_produit.xlsx
          - data/outputs/ca_total.csv
          - data/outputs/vins_millesimes.csv
          - data/outputs/vins_ordinaires.csv
          - data/outputs/resume_stats.csv
          - data/outputs/erp_exclu.csv
          - data/outputs/liaison_exclu.csv

        # üê≥ Configuration du conteneur Docker
        taskRunner:
          type: io.kestra.plugin.scripts.runner.docker.Docker

        containerImage: ghcr.io/kestra-io/pydata:latest
