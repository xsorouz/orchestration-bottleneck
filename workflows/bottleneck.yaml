# ========================================================
# üéØ Workflow d'automatisation des traitements BottleNeck
# ========================================================

id: pipeline-bottleneck_v2
namespace: bottleneck
description: >
  Workflow complet BottleNeck : t√©l√©chargement, transformation, validation,
  calculs analytiques, export final. Planifi√© chaque 15 du mois √† 9h00.

# ============================================================
# üìÖ D√©clencheur mensuel
# ============================================================
triggers:
  - id: planification-mensuelle
    type: io.kestra.plugin.core.trigger.Schedule
    cron: "0 9 15 * *"

# ============================================================
# üõ†Ô∏è Pipeline de t√¢ches
# ============================================================
tasks:
  - id: repertoire-travail
    type: io.kestra.plugin.core.flow.WorkingDirectory
    retry:
      type: constant
      maxAttempt: 2
      interval: PT2M
    tasks:

      # üì• Clonage du d√©p√¥t
      - id: clonage-depot
        type: io.kestra.plugin.git.Clone
        url: https://github.com/xsorouz/orchestration-bottleneck.git
        branch: main

      # üì• V√©rification des fichiers clon√©s
      - id: verifier-fichiers
        type: io.kestra.plugin.scripts.python.Commands
        namespaceFiles:
          enabled: true
        taskRunner:
          type: io.kestra.plugin.scripts.runner.docker.Docker
        containerImage: python:slim
        commands:
          - ls -R

      # üì¶ T√©l√©chargement des donn√©es brutes
      - id: telechargement-donnees
        type: io.kestra.plugin.scripts.python.Commands
        namespaceFiles:
          enabled: true
        taskRunner:
          type: io.kestra.plugin.scripts.runner.docker.Docker
        containerImage: python:slim
        beforeCommands:
          - pip install requests loguru
        commands:
          - python src/00_download_and_extract.py

      # üìÑ Conversion Excel -> CSV
      - id: conversion-excel-csv
        type: io.kestra.plugin.scripts.python.Commands
        namespaceFiles:
          enabled: true
        taskRunner:
          type: io.kestra.plugin.scripts.runner.docker.Docker
        containerImage: python:slim
        beforeCommands:
          - pip install pandas openpyxl loguru
        commands:
          - python src/01_excel_to_csv.py

      # ‚òÅÔ∏è Upload CSV bruts vers MinIO
      - id: upload-csv-bruts
        type: io.kestra.plugin.scripts.python.Commands
        namespaceFiles:
          enabled: true
        taskRunner:
          type: io.kestra.plugin.scripts.runner.docker.Docker
        containerImage: python:slim
        beforeCommands:
          - pip install boto3 loguru
        commands:
          - python src/02_upload_to_minio.py

      # ‚úÖ V√©rification de l'upload brut
      - id: verification-upload-brut
        type: io.kestra.plugin.scripts.python.Commands
        namespaceFiles:
          enabled: true
        taskRunner:
          type: io.kestra.plugin.scripts.runner.docker.Docker
        containerImage: python:slim
        beforeCommands:
          - pip install boto3 loguru
        commands:
          - python src/03_verify_upload.py

      # üßπ Nettoyage des donn√©es
      - id: nettoyage-donnees
        type: io.kestra.plugin.scripts.python.Commands
        namespaceFiles:
          enabled: true
        taskRunner:
          type: io.kestra.plugin.scripts.runner.docker.Docker
        containerImage: python:slim
        beforeCommands:
          - pip install duckdb pandas loguru
        commands:
          - python src/05_clean_data.py

      # üîç Tests de validation du nettoyage
      - id: tests-nettoyage
        type: io.kestra.plugin.scripts.python.Commands
        namespaceFiles:
          enabled: true
        taskRunner:
          type: io.kestra.plugin.scripts.runner.docker.Docker
        containerImage: python:slim
        beforeCommands:
          - pip install duckdb loguru
        commands:
          - python tests/test_05_clean_data.py
          - python tests/test_05_nulls_clean_data.py

      # ‚òÅÔ∏è Upload des fichiers nettoy√©s
      - id: upload-csv-nettoyes
        type: io.kestra.plugin.scripts.python.Commands
        namespaceFiles:
          enabled: true
        taskRunner:
          type: io.kestra.plugin.scripts.runner.docker.Docker
        containerImage: python:slim
        beforeCommands:
          - pip install boto3 loguru
        commands:
          - python src/06_upload_clean_to_minio.py

      # üóÇÔ∏è D√©doublonnage des donn√©es
      - id: dedoublonnage-donnees
        type: io.kestra.plugin.scripts.python.Commands
        namespaceFiles:
          enabled: true
        taskRunner:
          type: io.kestra.plugin.scripts.runner.docker.Docker
        containerImage: python:slim
        beforeCommands:
          - pip install duckdb pandas numpy loguru
        commands:
          - python src/08_dedoublonnage.py

      # üîç Tests de validation du d√©doublonnage
      - id: tests-dedoublonnage
        type: io.kestra.plugin.scripts.python.Commands
        namespaceFiles:
          enabled: true
        taskRunner:
          type: io.kestra.plugin.scripts.runner.docker.Docker
        containerImage: python:slim
        beforeCommands:
          - pip install duckdb pandas numpy loguru
        commands:
          - python tests/test_08_dedoublonnage.py
          - python tests/test_08_doublons.py

      # üîó Fusion des donn√©es
      - id: fusion-donnees
        type: io.kestra.plugin.scripts.python.Commands
        namespaceFiles:
          enabled: true
        taskRunner:
          type: io.kestra.plugin.scripts.runner.docker.Docker
        containerImage: python:slim
        beforeCommands:
          - pip install duckdb pandas numpy loguru
        commands:
          - python src/09_fusion.py

      # üîç Tests de validation de la fusion
      - id: tests-fusion
        type: io.kestra.plugin.scripts.python.Commands
        namespaceFiles:
          enabled: true
        taskRunner:
          type: io.kestra.plugin.scripts.runner.docker.Docker
        containerImage: python:slim
        beforeCommands:
          - pip install duckdb pandas numpy loguru
        commands:
          - python tests/test_09_fusion.py

      # üíæ Cr√©ation snapshot base
      - id: snapshot-base
        type: io.kestra.plugin.scripts.python.Commands
        namespaceFiles:
          enabled: true
        taskRunner:
          type: io.kestra.plugin.scripts.runner.docker.Docker
        containerImage: python:slim
        beforeCommands:
          - pip install duckdb pandas numpy loguru
        commands:
          - python src/10_create_snapshot.py

      # üí∞ Calcul du chiffre d'affaires
      - id: calcul-chiffre-affaires
        type: io.kestra.plugin.scripts.python.Commands
        namespaceFiles:
          enabled: true
        taskRunner:
          type: io.kestra.plugin.scripts.runner.docker.Docker
        containerImage: python:slim
        beforeCommands:
          - pip install duckdb pandas numpy boto3 loguru openpyxl
        commands:
          - python src/11_calcul_ca.py

      # üîç Tests de validation du chiffre d'affaires
      - id: tests-chiffre-affaires
        type: io.kestra.plugin.scripts.python.Commands
        namespaceFiles:
          enabled: true
        taskRunner:
          type: io.kestra.plugin.scripts.runner.docker.Docker
        containerImage: python:slim
        beforeCommands:
          - pip install duckdb pandas numpy loguru
        commands:
          - python tests/test_11_validate_ca.py

      # üç∑ Calcul du Z-score
      - id: calcul-zscore
        type: io.kestra.plugin.scripts.python.Commands
        namespaceFiles:
          enabled: true
        taskRunner:
          type: io.kestra.plugin.scripts.runner.docker.Docker
        containerImage: python:slim
        beforeCommands:
          - pip install duckdb pandas numpy boto3 loguru
        commands:
          - python src/12_calcul_zscore_upload.py

      # üîç Tests de validation du Z-score
      - id: tests-zscore
        type: io.kestra.plugin.scripts.python.Commands
        namespaceFiles:
          enabled: true
        taskRunner:
          type: io.kestra.plugin.scripts.runner.docker.Docker
        containerImage: python:slim
        beforeCommands:
          - pip install pandas numpy loguru
        commands:
          - python tests/test_12_validate_zscore.py

      # üìã G√©n√©ration du rapport final
      - id: generation-rapport-final
        type: io.kestra.plugin.scripts.python.Commands
        namespaceFiles:
          enabled: true
        taskRunner:
          type: io.kestra.plugin.scripts.runner.docker.Docker
        containerImage: python:slim
        beforeCommands:
          - pip install duckdb pandas numpy boto3 loguru openpyxl
        commands:
          - python src/13_generate_final_report.py

      - id: upload-logs-final
        type: io.kestra.plugin.scripts.python.Commands
        namespaceFiles:
          enabled: true
        taskRunner:
          type: io.kestra.plugin.scripts.runner.docker.Docker
        containerImage: python:slim
        beforeCommands:
          - pip install boto3 loguru
        commands:
          - python src/14_upload_all_logs.py          
